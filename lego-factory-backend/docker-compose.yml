version: '3.8'

services:
  # Root Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: lego-factory-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx-root-proxy/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - frontend
      - api-gateway
    networks:
      - app-network
    restart: unless-stopped

  # React Frontend with Nginx
  frontend:
    build:
      context: ../lego-factory-frontend
      dockerfile: Dockerfile
    container_name: lego-frontend
    expose:
      - "80"
    networks:
      - app-network
    restart: unless-stopped

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: lego-api-gateway
    expose:
      - "8080"
    depends_on:
      - user-service
      - masterdata-service
      - inventory-service
      - order-processing-service
      - simal-integration-service
    networks:
      - app-network
    restart: unless-stopped

  # User Service (PostgreSQL)
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: lego-user-service
    expose:
      - "8080"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres-db
    networks:
      - app-network
    restart: unless-stopped

  # Masterdata Service (H2)
  masterdata-service:
    build:
      context: ./masterdata-service
      dockerfile: Dockerfile
    container_name: lego-masterdata-service
    expose:
      - "8080"
    volumes:
      - masterdata_h2_data:/app/data
    networks:
      - app-network
    restart: unless-stopped

  # Inventory Service (H2)
  inventory-service:
    build:
      context: ./inventory-service
      dockerfile: Dockerfile
    container_name: lego-inventory-service
    expose:
      - "8080"
    volumes:
      - inventory_h2_data:/app/data
    networks:
      - app-network
    restart: unless-stopped

  # Order Processing Service (H2)
  order-processing-service:
    build:
      context: ./order-processing-service
      dockerfile: Dockerfile
    container_name: lego-order-processing-service
    expose:
      - "8080"
    volumes:
      - order_processing_h2_data:/app/data
    networks:
      - app-network
    restart: unless-stopped

  # Simal Integration Service (H2)
  simal-integration-service:
    build:
      context: ./simal-integration-service
      dockerfile: Dockerfile
    container_name: lego-simal-integration-service
    expose:
      - "8080"
    volumes:
      - simal_integration_h2_data:/app/data
    networks:
      - app-network
    restart: unless-stopped

  # PostgreSQL Database
  postgres-db:
    image: postgres:15-alpine
    container_name: lego-postgres-db
    environment:
      - POSTGRES_DB=lego_factory_auth
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_db_data:/var/lib/postgresql/data
    expose:
      - "5432"
    networks:
      - app-network
    restart: unless-stopped

volumes:
  postgres_db_data:
  masterdata_h2_data:
  inventory_h2_data:
  order_processing_h2_data:
  simal_integration_h2_data:

networks:
  app-network:
    driver: bridge
